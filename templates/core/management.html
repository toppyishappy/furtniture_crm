{% extends 'base.html' %}
{% load static %}
{% block content %}
<!-- modal -->
<div class="modal fade" id="myModal">
  <div class="modal-dialog">
      <div class="modal-content">
  
          <!-- Modal Header -->
          <div class="modal-header">
          <h4 class="modal-title" id="title"></h4>
          <div class="visually-hidden" id="hidden-id"></div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
  
          <!-- Modal body -->
          <div class="modal-body" id="department-content">
            <!-- <div class="row mb-2">
              <div class="col-4">{{department.name}}</div>
              <div class="col">
                <button type="button" class="btn btn-primary" onclick="handleAction('start', {{department.id}})">เริ่ม</button>
                <button type="button" class="btn btn-secondary" onclick="handleAction('stop', {{department.id}})">สิ้นสุด</button>
                <button type="button" class="btn btn-danger" onclick="handleAction('reject', {{department.id}})">reject</button>
              </div>
            </div> -->
          </div>
  
          <!-- Modal footer -->
          <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">ปิด</button>
          </div>
  
      </div>
  </div>
</div>
<!-- end modal -->
<div class="row">
  <div class="d-flex justify-content-between p-0">
    <div>
      <form action="" method="get">
        <div class="row">
          <div class="col-8">
            <input type="month" name="query" class="form-control">
          </div>
          <div class="col-3">
            <input type="submit" value="ค้นหา" class="btn btn-primary">
          </div>
        </div>
      </form>
    </div>
    <button type="button" class="btn btn-primary" onclick="exportExcel()">excel</button>
  </div>
</div>
<div class="row mt-4">
  <div class="card-body shadow">
    <table class="table table-striped">
      <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">วันที่ PO</th>
            <th scope="col">id</th>
            <th scope="col">หมายเลข PO</th>
            <th scope="col">ชื่อลูกค้า</th>
            <th scope="col">วันที่จัดส่ง</th>
            <th scope="col">สถานะ</th>
            <th scope="col">แผนก</th>
            <th scope="col">completed</th>
          </tr>
        </thead>
        <tbody>
          {% for item in page_obj %}
            {% if item.flag == 1%}
              <tr class="bg-warning">
            {% elif item.flag == 2%}
              <tr style="background: #ff6961;">
            {% else %}
              <tr class="">
            {% endif %}
                <td><input type="checkbox" name="" id="{{item.order.id}}" onchange="handleCheckBox(this)"></td>
                <td>{{item.order.form_date|date:"SHORT_DATE_FORMAT"}}</td>
                <td><a href="/purchase-order/{{item.order.id}}">{{item.order.id}}</a></td>
                <td>{{item.order.custom_po|default:"-"}}</td>
                <td>{{item.customer.fullname}}</td>
                <td>{{item.order.delivery_start_date|date:"SHORT_DATE_FORMAT"}} - {{item.order.delivery_end_date|date:"SHORT_DATE_FORMAT"}}</td>
                <td>{{item.status}}</td>
                <td><button class='btn btn-success' onclick="toggleModal({{item.order.id}})">Action</button></td>
                {% if item.is_completed %}
                  <td style="text-align: center;">
                    <img src="{% static 'check-circle-fill.svg'%}" alt="">
                  </td>
                {% else %}
                <td style="text-align: center;">
                  <img src="{% static 'x-circle-fill.svg'%}" alt="">
                </td>
                {% endif %}
          </tr>
        {% endfor %}
        </tbody>
    </table>
  </div>
  <div class="d-flex justify-content-center mt-2">
    <nav aria-label="Page navigation example">
      <ul class="pagination">
        {% if page_obj.has_previous %}
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a></li>
        {% endif %}
        {% for page in page_obj.paginator.page_range %}
          {% if page == page_obj.number %}
          <li class="page-item active" aria-current="page">
            <a class="page-link" href="?page={{page}}">{{ page }}</a>
          </li>
          {% else %}
            <li class="page-item"><a class="page-link" href="?page={{page}}">{{ page }}</a></li>
          {% endif %}
        {% endfor %}
        {% if page_obj.has_next %}
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a></li>
        {% endif %}
      </ul>
    </nav>
  </div>
</div>
{% endblock %}
{% block script %}
    <script>
      var idList = [];
      function handleCheckBox(e){
        if(e.checked){
          idList.push(parseInt(e.id))
        }else{
          idList = idList.filter(i => i === e.id);
        }
      }
      function exportExcel(){
        Swal.fire({
        title: 'ต้องการดาวโหลด excel ใช่หรือไม่?',
        text: "ยืนยันการดาวโหลด file excel!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'ยืนยัน',
        cancelButtonText: 'ยกเลิก'
      })
      .then(async (result) => {
        if (result.isConfirmed) {
          if(idList.length <= 0) return;
          path = `/export-excel?id_list=${idList}`;
          window.open(path)
        }
      })
      }
    </script>
    <script>
      function navigateToDetail(){
        window.location.href = '/purchase-order/1/'
      }
    </script>
    <script>
      const checkFlag = (flag) => {
        if(flag == 1){
          return '<span class="badge bg-info text-dark">start</span>'
        }else if(flag == 2){
          return '<span class="badge bg-info text-dark">stop</span>'
        }else if(flag == 3){
          return '<span class="badge bg-success text-white">done</span>'
        }else{
          return ''
        }
      }
      const toggleModal = async(orderId) => {
        var content = document.getElementById('department-content')
        var title = document.getElementById('title')
        var html = '';
        const path = `/api/department?order_id=${orderId}`;
        const res = await getData(path);
        if(res.ok){
          title.innerHTML = `<div>หมายเลข PO ${res.po_id}</div><div>ลูกค้า ${res.customer}</div>`
          for(let department of res.departments){
            var button = '';
            if(department.flag === 3){
            button = `
                <button type="button" disabled class="btn btn-primary" onclick="handleAction('start', ${department.id})">เริ่ม</button>
                <button type="button" disabled class="btn btn-secondary" onclick="handleAction('stop', ${department.id})">สิ้นสุด</button>
                <button type="button" class="btn btn-danger" onclick="handleAction('reject', ${department.id})">ยกเลิก</button>
            `
            }else if(department.flag === 0){
              button = `
                <button type="button" class="btn btn-primary" onclick="handleAction('start', ${department.id})">เริ่ม</button>
                <button type="button" disabled class="btn btn-secondary" onclick="handleAction('stop', ${department.id})">สิ้นสุด</button>
                <button type="button" disabled class="btn btn-danger" onclick="handleAction('reject', ${department.id})">ยกเลิก</button>
              `
            }else if(department.flag === 1){
              button = `
                <button type="button" disabled class="btn btn-primary" onclick="handleAction('start', ${department.id})">เริ่ม</button>
                <button type="button" class="btn btn-secondary" onclick="handleAction('stop', ${department.id})">สิ้นสุด</button>
                <button type="button" class="btn btn-danger" onclick="handleAction('reject', ${department.id})">ยกเลิก</button>
              `
            }else if(department.flag === 2){
              button = `
                <button type="button" class="btn btn-primary" onclick="handleAction('start', ${department.id})">เริ่ม</button>
                <button type="button" disabled class="btn btn-secondary" onclick="handleAction('stop', ${department.id})">สิ้นสุด</button>
                <button type="button" class="btn btn-danger" onclick="handleAction('reject', ${department.id})">ยกเลิก</button>
              `
            }
            html += `
              <div class="row mb-2">
                <div class="col-4">
                  ${department.name}
                  ${checkFlag(department.flag)}
                </div>
                <div class="col">
                  ${button}
                </div>
              </div>
            `
          }
        }
        content.innerHTML = html;
        document.getElementById('hidden-id').innerHTML = orderId
        var myModal = new bootstrap.Modal(document.getElementById('myModal'))
        myModal.show()
      }
      const handleAction = async(action, departmentId) => {
        const orderId = document.getElementById('hidden-id').innerHTML;
        const data = {
          action: action,
          order_id: orderId,
          department_id: departmentId
        }
        const path = '/api/management';
        const res = await postData(path, data);
        if(res.ok){
          Swal.fire({
            icon: 'success',
            title: 'เปลี่ยนสถานะสำเร็จแล้ว',
          }).then(result => {
            if(result.isConfirmed){
              window.location.reload();
            }
          })
        }
      }
    </script>
{% endblock %}